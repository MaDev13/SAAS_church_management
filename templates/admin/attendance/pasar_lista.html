{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}{{ title }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
  <a href="{% url 'admin:index' %}">Inicio</a>
  &rsaquo; <a href="{% url 'admin:attendance_attendance_changelist' %}">Asistencias</a>
  &rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
<h1>{{ title }}</h1>

{% if saved %}
<p class="church-success-msg">Asistencia guardada correctamente.</p>
{% endif %}

<p class="church-subtitle"><strong>Iglesia:</strong> {{ church.name }}</p>

<form method="post">
  {% csrf_token %}
  <div class="church-card">
    <div class="church-form-row">
      <div class="church-form-group">
        <label for="date">Fecha</label>
        <input type="date" name="date" id="date" value="{{ selected_date|date:'Y-m-d' }}" required>
      </div>
      <div class="church-form-group">
        <label for="service_type">Tipo de servicio</label>
        <select name="service_type" id="service_type">
          {% for value, label in service_choices %}
          <option value="{{ value }}" {% if service_type == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="church-form-group" id="otro-container" style="{% if service_type != 'OTRO' %}display: none;{% endif %}">
        <label for="service_notes">Especificar (cuando es Otro)</label>
        <input type="text" name="service_notes" id="service_notes" maxlength="100"
               value="{{ service_notes|default:'' }}" placeholder="ej: Conferencia, Bautizo...">
      </div>
      <div class="church-form-group">
        <label>&nbsp;</label>
        <button type="submit" class="button default">Guardar asistencia</button>
      </div>
    </div>
  </div>

  <div class="church-table-wrap">
    <table class="church-table">
      <thead>
        <tr>
          <th style="width: 80px;">Presente</th>
          <th>Nombre</th>
          <th>Teléfono</th>
          <th>Ministerio</th>
        </tr>
      </thead>
      <tbody>
        {% for member in members %}
        <tr>
          <td>
            <input type="checkbox" name="member_{{ member.id }}" id="member_{{ member.id }}"
                   {% if member.id in attended_ids %}checked{% endif %}>
          </td>
          <td>
            <label for="member_{{ member.id }}">{{ member.last_name }}, {{ member.first_name }}</label>
          </td>
          <td>{{ member.phone|default:"—" }}</td>
          <td>{{ member.ministry.name|default:"—" }}</td>
        </tr>
        {% empty %}
        <tr class="church-empty-row">
          <td colspan="4">
            No hay miembros activos en esta iglesia. Agregue miembros en la sección Members.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</form>

<a href="{% url 'admin:attendance_attendance_changelist' %}" class="church-back-link">&larr; Volver a Asistencias</a>

<script>
document.getElementById('service_type').addEventListener('change', function() {
  var otroDiv = document.getElementById('otro-container');
  otroDiv.style.display = this.value === 'OTRO' ? 'block' : 'none';
});
</script>
{% endblock %}
